<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>jQuery Mobile: Theme Download</title>
	<link rel="stylesheet" href="themes/taller.min.css" />
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.1/jquery.mobile.structure-1.2.1.min.css" />
	<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.2.1/jquery.mobile-1.2.1.min.js"></script>
	<script src="themes/js/function.js"></script>
	<script>
	
		db = window.openDatabase("TallerSqlStorage", "1.0", "Base de datos", 5*1024*1024);
		$(document).ready(function(){	
			if (localStorage.userState == "false") {
				redirect('login.html');
			}
			else{
				//aca todo lo demas
				$('#nomUsuario').html(localStorage.userName);
				//chekea si viene de crear una cuenta
				if(localStorage.cuentaNueva == 'true'){
					$('#errorMessage').show().html("<div class='alert alert-danger' role='alert'><strong>Exito!!</strong>la cuenta fue creada</div>");
					localStorage.setItem('cuentaNueva', 'false');
				}
				//CARGA TODAS LAS CUENTAS
				cargarCuentas(); 
			}
		});
		
		//CARGAR CUENTAS		
		function cargarCuentas(){
			var listadoCuentas = $('ul:first');
			db.transaction(function (tx) { 
				tx.executeSql('CREATE TABLE IF NOT EXISTS Cuentas (nombre, moneda, importe, usuario)',[],function(tx,results){
					tx.executeSql('select * from Cuentas where usuario = ?',[localStorage.userName],function(tx,results){
						for(var i = 0; i < results.rows.length;i++){
							var lista = $('ul:first');
							var aux = results.rows.item(i);
							var cuentaNom = aux.nombre;
							var cuentaImpo = aux.importe;
							lista.append("<li><a href='#detalle' data-id='"+aux.nombre+"' data-importe='"+aux.importe+"' onclick='cargar($(this).attr(\"data-id\"),$(this).attr(\"data-importe\"))'><h2>"+aux.nombre+"</h2><p>"+aux.importe+"</p></a></li>");							
							console.log(results.rows.item(i).nombre);							
							//$('#contenido').html(aux.nombre + aux.importe);							
						}
						 lista.listview().listview('refresh');
					});
				});
			});
			
		}
		
		//Detalle de cuenta
		function cargar(nombreCuenta, importeCuenta){
			localStorage.setItem('nomCuenta', nombreCuenta);
			cargarMovimientos(nombreCuenta);
			//$.mobile.loading("show");
			$('#nomCuenta').html(nombreCuenta);
			$('#impoCuenta').html(importeCuenta);
		}
		
		//CARGAR MOVIMIENTOS
		function cargarMovimientos(nombrecuenta){
			var listadoMovimientos = $('#movimientosCuenta');
			db.transaction(function (tx) { 				
				tx.executeSql('select * from movimientos where usuario=? AND nomCuenta=?',[localStorage.userName, localStorage.nomCuenta],function(tx,results){
					for(var i = 0; i < results.rows.length;i++){
						var lista = $('#movimientosCuenta');
						var aux = results.rows.item(i);
						lista.append("<li><h4>"+ aux.importe + "</h4><p>" +aux.tipo+"</p><p>"+aux.tipoMov+"</p><p>"+aux.dsc+"</p></li>");							
						console.log(results.rows.item(i).nombre);							
						//$('#contenido').html(aux.nombre + aux.importe);							
					}
					 lista.listview().listview('refresh');
				});
			});
		}
		
		
		
		//AGREGAR INGRESO
		function agregarIngreso(){
			//Categoria Ingresos
			$.ajax({
				type: "GET",
				dataType: "json",
				url: "http://finanzapersonal.tribus.com.uy/categoriaIngresos",
				data:{},
				success: function(data){
					resul = data;
					for(var i = 0; i< resul.length ; i++ ){
						var aux = resul[i];
						$("#selectTipoingreso").append("<option>"+ aux +"</option>");
					}
				}
			});
		}
		
		//AGREGAR GASTO
		function agregarGasto(){
			//Categoria Gastos
			$.ajax({
				type: "GET",
				dataType: "json",
				url: "http://finanzapersonal.tribus.com.uy/categoriasGastos",
				data:{},
				success: function(data){
					resul = data;
					for(var i = 0; i< resul.length ; i++ ){
						var aux = resul[i];
						$("#selectTipoGasto").append("<option>"+ aux +"</option>");
					}
				}
			});
		}
		
		//CREAR INGRESO
		function crearingreso(importe, tipo, dsc, usuario)
		{
			db.transaction(function (tx) { 
				tx.executeSql('CREATE TABLE IF NOT EXISTS Movimientos (importe, tipo, dsc, usuario, nomCuenta, tipoMov)',[],function(tx,results){
					tx.executeSql('INSERT INTO Movimientos (importe, tipo, dsc, usuario, nomCuenta, tipoMov) VALUES (?, ?, ?, ?, ?, ?)',[importe, tipo, dsc, usuario, localStorage.nomCuenta, "Ingreso"],function(){
						alert("Ingreso creado con exito!");
				});
				});
			});
			redirect('cuentas.html#listaGastoIngreso');
		}
		
		//CREAR GASTO
		function crearGasto(importe, tipo, dsc, usuario)
		{
			db.transaction(function (tx) { 
				tx.executeSql('CREATE TABLE IF NOT EXISTS Movimientos (importe, tipo, dsc, usuario, nomCuenta, tipoMov)',[],function(tx,results){
					tx.executeSql('INSERT INTO Movimientos (importe, tipo, dsc, usuario, nomCuenta, tipoMov) VALUES (?, ?, ?, ?, ?, ?)',[importe, tipo, dsc, usuario, localStorage.nomCuenta, "Gasto"],function(){
						alert("Gasto creado con exito!");
				});
				});
			});
			redirect('cuentas.html#listaGastoIngreso');
		}
	</script>
</head>
<body>
	<div data-role="page" data-theme="a">
		<div data-role="header" data-position="inline">
			<a class="ui-btn-left ui-btn ui-btn-icon-notext ui-btn-corner-all ui-shadow ui-btn-up-a" data-iconpos="notext" data-theme="a" data-role="button" data-icon="home" onclick='redirect("inicio.html")' title="Back">
				<span class="ui-btn-inner ui-btn-corner-all">
					<span class="ui-btn-text"> Home </span>
					<span data-form="ui-icon" class="ui-icon ui-icon-back ui-icon-shadow"></span>
				</span>
			</a>
			<h1>Cuentas</h1>
			<a class="ui-btn-right ui-btn ui-btn-icon-notext ui-btn-corner-all ui-shadow ui-btn-up-a" data-iconpos="notext" data-theme="a" data-role="button" data-icon="home" title="Home">
				<span class="ui-btn-inner ui-btn-corner-all">
					<span class="ui-btn-text"> Home </span>
					<span data-form="ui-icon" class="ui-icon ui-icon-home ui-icon-shadow"></span>
				</span>
			</a>
		</div>
		<div data-role="content" data-theme="a">
			<div style="display:none" id="errorMessage"></div>
			<p id="nomUsuario">Nombre Usuario</p>
			<hr>
			<p>Seleccione una Cuenta:</p>
			
			<ul id="listadoCuentas" data-role='listview' data-inset="true">
				<!--  <li>
					<a href='#detalle'><span>Cuenta 1</span></a>
				</li>
				<li>
					<a href='#detalle'><span>Cuenta 2</span></a>
				</li>  -->
			</ul> 
			
			<hr>
			<a onclick='redirect("alta-cuenta.html")' data-role='button' >Crear Nueva Cuenta</a>
		</div>
	</div>
	
	<div id='detalle' data-theme="a" data-role="page" data-add-back-btn='true' data-back-btn-text='Atras'>
		<div data-role="header">
			<h1>Detalle de la Cuenta</h1>
		</div><!-- /header -->
		<div data-role="content" id='contenido'>
			<p id="nomUsuario">Nombre Usuario</p>
			<hr>
			<a data-role='button' href="#agregarIngreso" onclick="agregarIngreso()" >+ Agregar Ingreso</a>
			<a data-role='button' href="#agregarGasto" onclick="agregarGasto()" >- Agregar Gasto</a>
			<ul id="listadoCuentas" data-role='listview' data-inset="true">
				<li>
					<h3 id="nomCuenta"></h3>
					<h4 id="impoCuenta"></h3>
				</li>
			</ul>
			<span>Movimientos</span>
			<ul id="movimientosCuenta" data-role='listview' data-inset="true">
			</ul>
		</div><!-- /content -->
	</div><!-- /page -->
	
	<div id="agregarIngreso" data-theme="a" data-role="page" data-add-back-btn='true' data-back-btn-text='Atras'>
		<div data-role="header">
			<h1>Agregar Ingreso</h1>
		</div><!-- /header -->
		<div data-role="content" id='contenido'>
			<label for="basic">Categoria: </label>
			<select id="selectTipoingreso" >
			</select>
			<label for="text-basic">Importe</label>
			<input type="number" name="text-basic" id="txtImporteIng" placeholder="$" value="">
			<label for="text-basic">Descripcion:</label>
			<input type="text" name="text-basic" id="txtDscIng" value="" placeholder="Ej: Gasto Auto">
			<a data-role='button' onclick='crearIngreso($("#txtImporteIng").val(), $("#selectTipoingreso").val(), $("#txtDscIng").val(),localStorage.userName)'>Confirmar</a>
			<hr>
		</div><!-- /content -->
	</div>
	
	<div id="agregarGasto" data-theme="a" data-role="page" data-add-back-btn='true' data-back-btn-text='Atras'>
		<div data-role="header">
			<h1>Agregar Gasto</h1>
		</div><!-- /header -->
		<div data-role="content" id='contenido'>
			<label for="basic">Categoria: </label>
			<select id="selectTipoGasto" >
			</select>
			<label for="text-basic">Importe</label>
			<input type="number" name="text-basic" id="txtImporte" placeholder="$" value="">
			<label for="text-basic">Descripcion:</label>
			<input type="text" name="text-basic" id="txtDsc" value="" placeholder="Ej: Gasto Auto">
			<a data-role='button' onclick='crearGasto($("#txtImporte").val(), $("#selectTipoGasto").val(), $("#txtDsc").val(), localStorage.userName)'>Confirmar</a>
			<hr>
		</div><!-- /content -->
	</div>
	
</body>
</html>